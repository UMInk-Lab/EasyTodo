<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <title>{{ title or '登录 / 注册 - EasyTodo' }}</title>
    <meta name="theme-color" content="#f7f8fa" id="theme-color" />
    <link rel="icon" href="/static/favicon.svg" />
    <link rel="manifest" href="/static/manifest.webmanifest" />
    <link rel="stylesheet" href="/static/css/global.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <script>
      // Early apply theme + address bar color to avoid flash
      (function(){
        var t = localStorage.getItem('theme');
        if(t==='dark'||t==='light') document.documentElement.setAttribute('data-theme', t);
        try{
          var isDark = false;
          if(t==='dark') isDark = true;
          else if(t==='light') isDark = false;
          else {
            var mql = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)');
            isDark = !!(mql && mql.matches);
          }
          var meta = document.querySelector('meta[name="theme-color"]');
          if(!meta){ meta = document.createElement('meta'); meta.setAttribute('name','theme-color'); document.head.appendChild(meta); }
          meta.setAttribute('content', isDark ? '#0b0e11' : '#f7f8fa');
        }catch(_){ /* no-op */ }
      })();
    </script>
  </head>
  <body data-title-key="login.title">
    <div class="auth-card">
      <div class="toolbar" style="margin-bottom:8px">
        <h2 class="auth-title" style="margin:0" data-i18n="login.header">登录 / 注册</h2>
        <div class="spacer"></div>
        <button id="themeBtn" class="btn icon" data-i18n-title="index.theme" data-i18n-aria-label="index.theme" title="切换明暗" aria-label="切换明暗"><i class="fa-solid fa-circle-half-stroke"></i></button>
        <button id="languageBtn" class="btn icon" data-i18n-title="index.language" data-i18n-aria-label="index.language" title="切换语言" aria-label="切换语言"><iconify-icon icon="material-symbols:language"></iconify-icon></button>
      </div>
      <p class="note" data-i18n="login.emailPasswordHint">使用邮箱与至少 8 位密码</p>
      <div>
        <label class="note" data-i18n="login.email">邮箱</label>
        <input id="email" class="auth-input" type="email" data-i18n-placeholder="login.emailPlaceholder" placeholder="you@example.com" />
      </div>
      <div style="margin-top:8px">
        <label class="note" data-i18n="login.password">密码</label>
        <input id="password" class="auth-input" type="password" data-i18n-placeholder="login.passwordPlaceholder" placeholder="至少8位" />
      </div>
      <div class="auth-actions" style="align-items:center">
        <button id="login" class="btn primary" data-i18n="login.login">登录</button>
        {% if registration_open %}
        <button id="register" class="btn" data-i18n="login.register">注册</button>
        {% else %}
        <span class="reg-disabled-wrap" style="position:relative; display:inline-block">
          <button id="register" class="btn" disabled data-i18n-title="login.registrationClosed" data-i18n="login.register" title="已关闭注册">注册</button>
          <!-- Overlay to capture clicks and show message when registration is closed -->
          <button id="registerOverlay" class="btn" aria-disabled="true" data-i18n-title="login.registrationClosedTitle" title="站点已关闭注册"
                  style="position:absolute; inset:0; background:transparent; border:none; padding:0; margin:0; opacity:0; cursor:not-allowed"></button>
        </span>
        {% endif %}
        <div class="spacer"></div>
        {% if smtp_enabled %}
        <a id="forgotLink" href="#" class="note" style="display:inline-flex;align-items:center;height:var(--control-h);text-decoration:none" data-i18n="login.forgotPassword">忘记密码？</a>
        {% endif %}
      </div>
      <p class="note" id="msg"></p>
    </div>

    {% if smtp_enabled %}
    <!-- Forgot Password Modal -->
    <div id="fpModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
      <div class="modal">
        <div class="toolbar" style="margin-bottom:8px">
          <h4 class="modal-title" id="fpTitle" style="margin:0" data-i18n="login.forgotPasswordTitle">找回密码</h4>
          <div class="spacer"></div>
          <button id="fpCloseBtn" class="btn icon" data-i18n-title="common.close" data-i18n-aria-label="common.close" title="关闭" aria-label="关闭"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div id="fpStep1">
          <p class="note" data-i18n="login.forgotPasswordHint">输入注册邮箱，系统将为你重置密码并发送到邮箱。</p>
          <input id="fpEmail" type="email" data-i18n-placeholder="login.emailPlaceholder" placeholder="you@example.com" />
          <div class="modal-actions">
            <button id="fpCancel1" class="btn" data-i18n="common.cancel">取消</button>
            <button id="fpNext" class="btn primary" data-i18n="common.next">下一步</button>
          </div>
        </div>
        <div id="fpStep2" style="display:none">
          <p class="note" data-i18n="login.resetChallenge">请解答以确认重置：</p>
          <div id="fpChallenge" class="note" style="font-weight:bold; margin-bottom:8px"></div>
          <input id="fpAnswer" type="text" data-i18n-placeholder="login.result" placeholder="结果" />
          {% if turnstile_enabled and turnstile_site_key %}
          <div style="margin:8px 0">
            <div id="tsWidget" class="cf-turnstile" data-sitekey="{{ turnstile_site_key }}" data-callback="onTsSuccess"></div>
          </div>
          {% endif %}
          <div class="modal-actions">
            <button id="fpBack" class="btn" data-i18n="common.back">返回</button>
            <button id="fpConfirm" class="btn danger" disabled data-i18n="login.confirmReset">确认重置</button>
          </div>
        </div>
        <div id="fpStep3" style="display:none">
          <p class="note" data-i18n="login.resetSuccess">新密码已发送至你的邮箱，请注意查收（收件箱/垃圾箱）。</p>
        </div>
        <div id="fpMsg" class="note"></div>
      </div>
    </div>
    {% endif %}

    <script>
      const msg = document.getElementById('msg');
      async function post(path, body){
        msg.textContent='';
        const r = await fetch(path, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
          credentials: 'include',
        });
        if(!r.ok){
          const j = await r.json().catch(()=>({}));
          const code = j.error || ('HTTP '+r.status);
          const text = mapError(code, path.includes('login'));
          throw new Error(text);
        }
        return r.json();
      }
      function mapError(code, isLogin){
        const dict = {
          invalid_credentials: window.i18n.t('login.errorInvalidCredentials'),
          invalid_email: window.i18n.t('login.errorInvalidEmail'),
          weak_password: window.i18n.t('login.errorWeakPassword'),
          email_taken: window.i18n.t('login.errorEmailTaken'),
          unauthorized: window.i18n.t('login.errorUnauthorized'),
          registration_closed: window.i18n.t('login.errorRegistrationClosed'),
        };
        if(dict[code]) return dict[code];
        if(isLogin) return window.i18n.t('login.errorLoginFailed');
        return window.i18n.t('login.errorRegisterFailed');
      }
      document.getElementById('login').onclick = async () =>{
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value;
        try{
          await post('/api/auth/login', { email, password });
          try{ localStorage.removeItem('loggedOut'); }catch{}
          location.href = '/';
        }catch(e){ msg.textContent = window.i18n.t('login.loginFailedPrefix')+e.message }
      }
      const regBtn = document.getElementById('register');
      if(regBtn && !regBtn.disabled){
        regBtn.onclick = async () =>{
          const email = document.getElementById('email').value.trim();
          const password = document.getElementById('password').value;
          try{
            await post('/api/auth/register', { email, password });
            try{ localStorage.removeItem('loggedOut'); }catch{}
            location.href = '/';
          }catch(e){ msg.textContent = window.i18n.t('login.registerFailedPrefix')+e.message }
        };
      }
      // When registration is closed, show a clear message on click
      const regOverlay = document.getElementById('registerOverlay');
      if(regOverlay){
        regOverlay.addEventListener('click', (e)=>{
          e.preventDefault();
          msg.textContent = window.i18n.t('login.errorRegistrationClosed');
        });
      }
      const fl = document.getElementById('forgotLink');
      const fpModal = document.getElementById('fpModal');
      const fpEmail = document.getElementById('fpEmail');
      const fpNext = document.getElementById('fpNext');
      const fpCancel1 = document.getElementById('fpCancel1');
      const fpBack = document.getElementById('fpBack');
      const fpConfirm = document.getElementById('fpConfirm');
      const fpStep1 = document.getElementById('fpStep1');
      const fpStep2 = document.getElementById('fpStep2');
      const fpStep3 = document.getElementById('fpStep3');
      const fpCloseBtn = document.getElementById('fpCloseBtn');
      const fpMsg = document.getElementById('fpMsg');
      const fpChallenge = document.getElementById('fpChallenge');
      let tsToken = '';
      window.onTsSuccess = function(token){ tsToken = token; updateConfirmState(); };
      function showStep(step){
        if(fpStep1) fpStep1.style.display = (step===1?'':'none');
        if(fpStep2) fpStep2.style.display = (step===2?'':'none');
        if(fpStep3) fpStep3.style.display = (step===3?'':'none');
      }
      function openFp(){
        if(fpModal){
          // prefill from login email
          const e = document.getElementById('email');
          if(e && fpEmail) fpEmail.value = e.value.trim();
          fpMsg.textContent = '';
          showStep(1);
          fpConfirm.disabled = true;
          fpModal.style.display = 'flex';
          fpModal.setAttribute('aria-hidden','false');
          setTimeout(()=>fpEmail && fpEmail.focus(), 0);
        }
      }
      function closeFp(){
        if(fpModal){
          fpModal.style.display = 'none';
          fpModal.setAttribute('aria-hidden','true');
        }
        fpMsg.textContent = '';
        tsToken = '';
      }
      function updateConfirmState(){
        const needsTs = !!({{ 'true' if (turnstile_enabled and turnstile_site_key) else 'false' }});
        if(!fpConfirm) return;
        if(needsTs){
          fpConfirm.disabled = !tsToken;
        }else{
          fpConfirm.disabled = false;
        }
      }
      if(fl){ fl.addEventListener('click', (e)=>{ e.preventDefault(); openFp(); }); }
      if(fpCancel1){ fpCancel1.addEventListener('click', closeFp); }
      if(fpBack){ fpBack.addEventListener('click', ()=>{ fpStep1.style.display=''; fpStep2.style.display='none'; fpMsg.textContent=''; updateConfirmState(); }); }
      if(fpNext){
        fpNext.addEventListener('click', async ()=>{
          fpMsg.textContent = '';
          const emailVal = (fpEmail.value||'').trim().toLowerCase();
          if(!emailVal || !emailVal.includes('@')){ fpMsg.textContent=window.i18n.t('login.enterValidEmail'); return }
          fpNext.disabled = true;
          try{
            const r = await fetch('/api/auth/forgot/start', { method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body: JSON.stringify({ email: emailVal }) });
            const j = await r.json().catch(()=>({}));
            if(!r.ok){
              const map = { 
                invalid_email: window.i18n.t('login.errorInvalidEmail'), 
                not_found: window.i18n.t('login.errorNotFound')
              };
              throw new Error(map[j.error] || (j.error || ('HTTP '+r.status)));
            }
            fpChallenge.textContent = j.challenge || '';
            showStep(2);
            fpMsg.textContent = '';
            tsToken = '';
            updateConfirmState();
            // Ensure Turnstile widget refreshes to issue a fresh token
            try{ if(window.turnstile){ window.turnstile.reset(); } }catch(_){ }
          }catch(e){ fpMsg.textContent = window.i18n.t('login.requestFailed') + (e && e.message? e.message : window.i18n.t('login.unknownError')); }
          finally{ fpNext.disabled = false; }
        });
        fpConfirm.addEventListener('click', async ()=>{
          try{
            fpMsg.textContent = '';
            const emailVal = (fpEmail && fpEmail.value||'').trim().toLowerCase();
            const ansEl = document.getElementById('fpAnswer');
            const answer = ((ansEl && ansEl.value) || '').trim();
            const needsTs = !!({{ 'true' if (turnstile_enabled and turnstile_site_key) else 'false' }});
            if(needsTs && !tsToken){ fpMsg.textContent = window.i18n.t('login.completeChallenge'); return }
            if(!answer){ fpMsg.textContent = window.i18n.t('login.enterAnswer'); return }
            fpConfirm.disabled = true;
            const r = await fetch('/api/auth/forgot/confirm', { method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body: JSON.stringify({ email: emailVal, answer, turnstile_token: tsToken||'' }) });
            const j = await r.json().catch(()=>({}));
            if(!r.ok){
              const map = { 
                bad_challenge: window.i18n.t('login.errorBadChallenge'),
                turnstile_failed: window.i18n.t('login.errorTurnstileFailed'),
                smtp_invalid: window.i18n.t('login.errorSmtpInvalid'),
                smtp_auth_failed: window.i18n.t('login.errorSmtpAuthFailed'),
                smtp_send_failed: window.i18n.t('login.errorSmtpSendFailed'),
                not_found: window.i18n.t('login.errorNotFound')
              };
              let base = map[j.error] || (j.error || ('HTTP '+r.status));
              if(j.error === 'turnstile_failed' && j.detail){ base += `（${j.detail}）`; }
              throw new Error(base);
            }
            // Success: show success page in modal; do not auto close
            if(fpTitle) fpTitle.textContent = window.i18n.t('login.forgotPasswordTitle');
            showStep(3);
            fpMsg.textContent = '';
          }catch(e){
            fpMsg.textContent = window.i18n.t('login.resetFailedPrefix') + (e && e.message? e.message : window.i18n.t('login.unknownError'));
            // Reset token on failure to encourage a fresh solve
            tsToken = '';
            try{ if(window.turnstile){ window.turnstile.reset(); } }catch(_){ }
            updateConfirmState();
          }finally{
            fpConfirm.disabled = false;
          }
        });
      }
      if(fpCloseBtn){ fpCloseBtn.addEventListener('click', closeFp); }
  </script>
    {% if turnstile_enabled and turnstile_site_key %}
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
    {% endif %}
    <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
    <script src="/static/js/locales/zh-CN.js"></script>
    <script src="/static/js/locales/en.js"></script>
    <script src="/static/js/locales/ja.js"></script>
    <script src="/static/js/i18n.js"></script>
    <script src="/static/js/theme.js"></script>
    <script src="/static/js/pwa.js"></script>
    <script>
      // Initialize language button after i18n is loaded
      (function initLanguage() {
        function init() {
          if (window.i18n && window.i18n.initLanguageButton) {
            window.i18n.initLanguageButton();
          } else {
            // Retry if i18n not ready yet
            setTimeout(init, 50);
          }
        }
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', init);
        } else {
          init();
        }
      })();
    </script>
    <footer class="site-footer">
      Powered by <a href="https://github.com/umink-lab/easytodo" target="_blank" rel="noopener noreferrer">EasyTodo</a> · Copyright <a href="https://github.com/essesoul" target="_blank" rel="noopener noreferrer">Essesoul</a>
    </footer>
  </body>
  </html>
