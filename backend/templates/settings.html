<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{ title or '设置 - EasyTodo' }}</title>
    <meta name="theme-color" content="#f7f8fa" id="theme-color" />
    <meta name="csrf-token" content="{{ csrf_token }}" />
    <link rel="icon" href="/static/favicon.svg" />
    <link rel="manifest" href="/static/manifest.webmanifest" />
    <link rel="stylesheet" href="/static/css/global.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <script>
      // Early apply theme + address bar color to avoid flash
      (function(){
        var t = localStorage.getItem('theme');
        if(t==='dark'||t==='light') document.documentElement.setAttribute('data-theme', t);
        try{
          var isDark = false;
          if(t==='dark') isDark = true;
          else if(t==='light') isDark = false;
          else {
            var mql = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)');
            isDark = !!(mql && mql.matches);
          }
          var meta = document.querySelector('meta[name="theme-color"]');
          if(!meta){ meta = document.createElement('meta'); meta.setAttribute('name','theme-color'); document.head.appendChild(meta); }
          meta.setAttribute('content', isDark ? '#0b0e11' : '#f7f8fa');
        }catch(_){ /* no-op */ }
      })();
    </script>
  </head>
  <body data-title-key="settings.title">
    <div class="container">
      <div class="toolbar">
        <button id="backBtn" class="btn icon" data-i18n-title="common.back" data-i18n-aria-label="common.back" title="返回" aria-label="返回"><i class="fa-solid fa-arrow-left"></i></button>
        <div class="spacer"></div>
        <button id="themeBtn" class="btn icon" data-i18n-title="index.theme" data-i18n-aria-label="index.theme" title="切换明暗" aria-label="切换明暗"><i class="fa-solid fa-circle-half-stroke"></i></button>
        <button id="languageBtn" class="btn icon" data-i18n-title="index.language" data-i18n-aria-label="index.language" title="切换语言" aria-label="切换语言"><iconify-icon icon="material-symbols:language"></iconify-icon></button>
        <button id="logoutBtn" class="btn icon" data-i18n-title="index.logout" data-i18n-aria-label="index.logout" title="退出登录" aria-label="退出登录"><i class="fa-solid fa-right-from-bracket"></i></button>
      </div>

      <h3 class="auth-title" style="margin-top:12px" data-i18n="settings.accountSettings">账户设置</h3>
      <div class="note"><span data-i18n="settings.currentEmail">当前邮箱：</span><strong id="email">{{ email }}</strong></div>

      <div style="margin-top:16px;border:1px solid var(--border);border-radius:12px;padding:16px">
        <h4 class="auth-title" style="margin:0 0 8px 0" data-i18n="settings.changePassword">修改密码</h4>
        <input id="current" class="auth-input" type="password" data-i18n-placeholder="settings.currentPassword" placeholder="当前密码" style="margin-top:8px" />
        <input id="new" class="auth-input" type="password" data-i18n-placeholder="settings.newPassword" placeholder="新密码（至少8位）" style="margin-top:8px" />
        <input id="confirm" class="auth-input" type="password" data-i18n-placeholder="settings.confirmPassword" placeholder="再次输入新密码" style="margin-top:8px" />
        <div class="auth-actions">
          <button id="changePwdBtn" class="btn primary" data-i18n-title="settings.savePassword" data-i18n-aria-label="settings.savePassword" title="保存新密码" aria-label="保存新密码"><i class="fa-solid fa-floppy-disk"></i></button>
        </div>
        <div class="note" id="pwdMsg"></div>
      </div>

      {% if not is_admin %}
      <div style="margin-top:16px;border:1px solid var(--border);border-radius:12px;padding:16px">
        <h4 class="auth-title" style="margin:0 0 8px 0" data-i18n="settings.deleteAccount">删除账号</h4>
        <p class="note" data-i18n="settings.deleteAccountWarning">此操作不可恢复，将删除账号以及所有相关数据。</p>
        <button id="deleteAccountOpen" class="btn danger" data-i18n="settings.deleteAccountButton">删除账号</button>
      </div>
      {% endif %}

      {% if is_admin %}
      <div style="margin-top:16px;border:1px solid var(--border);border-radius:12px;padding:16px">
        <h4 class="auth-title" style="margin:0 0 8px 0" data-i18n="settings.systemManagement">系统管理</h4>

        <div class="row" style="margin-top:10px; gap:10px; align-items:center">
          <label class="note" style="min-width:110px" data-i18n="settings.registrationOpen">开放注册</label>
          <label class="switch">
            <input id="registration_open" type="checkbox" />
            <span class="slider"></span>
          </label>
          <span class="note" id="regHelp" data-i18n="settings.allowNewUsers">允许新用户注册</span>
        </div>

        <div class="section-divider"></div>

        <div style="margin-top:4px">
          <div class="row" style="margin:8px 0; align-items:center">
            <h5 class="auth-title" style="margin:0; flex:1"><span data-i18n="settings.turnstile">验证码</span>（<a href="https://www.cloudflare.com/application-services/products/turnstile/" target="_blank" rel="noopener noreferrer" style="color:inherit">Cloudflare Turnstile</a>）</h5>
            <div class="row" style="align-items:center; gap:8px">
              <label class="switch">
                <input id="turnstile_enabled" type="checkbox" />
                <span class="slider"></span>
              </label>
              <label class="note" data-i18n="settings.enableTurnstile">启用验证码</label>
            </div>
          </div>
          <div class="smtp-grid" style="margin-top:8px">
            <input id="turnstile_site_key" class="auth-input" data-i18n-placeholder="settings.siteKey" placeholder="Site Key" />
            <input id="turnstile_secret_key" class="auth-input" data-i18n-placeholder="settings.secretKey" placeholder="Secret Key" />
          </div>
          <div class="row" style="align-items:center; gap:8px; margin-top:8px">
            <input id="turnstile_tls_skip_verify" type="checkbox" />
            <label class="note" for="turnstile_tls_skip_verify" data-i18n="settings.skipTlsVerify">跳过 TLS 验证</label>
          </div>
          <div class="auth-actions" style="display:flex; gap:8px; align-items:center; justify-content:flex-start">
            <button id="saveTsBtn" class="btn primary" data-i18n-title="settings.saveTurnstile" data-i18n-aria-label="settings.saveTurnstile" title="保存" aria-label="保存"><i class="fa-solid fa-floppy-disk"></i></button>
          </div>
          <div class="note" id="tsMsg"></div>
        </div>

        <div class="section-divider"></div>

        <div style="margin-top:4px">
          <div class="row" style="margin:8px 0; align-items:center">
            <h5 class="auth-title" style="margin:0; flex:1" data-i18n="settings.smtp">SMTP 设置</h5>
            <div class="row" style="align-items:center; gap:8px">
              <label class="switch">
                <input id="smtp_enabled" type="checkbox" />
                <span class="slider"></span>
              </label>
              <label class="note" data-i18n="settings.enableSmtp">启用 SMTP</label>
            </div>
          </div>
          <div class="smtp-grid" style="margin-top:8px">
            <input id="smtp_host" class="auth-input" data-i18n-placeholder="settings.smtpServer" placeholder="SMTP Server" />
            <input id="smtp_port" class="auth-input" data-i18n-placeholder="settings.smtpPort" placeholder="Port" />
            <input id="smtp_username" class="auth-input" data-i18n-placeholder="settings.smtpUsername" placeholder="Username" />
            <input id="smtp_password" class="auth-input" data-i18n-placeholder="settings.smtpPassword" type="password" placeholder="Password" />
            <input id="smtp_sender" class="auth-input" data-i18n-placeholder="settings.smtpFrom" placeholder="From" />
            <div class="row" style="align-items:center; gap:10px">
              <label class="note tls-label" data-i18n="settings.smtpTls">TLS</label>
              <label class="switch">
                <input id="smtp_use_tls" type="checkbox" />
                <span class="slider"></span>
              </label>
            </div>
            <div class="row" style="align-items:center; gap:10px">
              <label class="note" data-i18n="settings.smtpSkipVerify" data-i18n-title="settings.smtpSkipVerify" title="跳过验证">跳过验证</label>
              <label class="switch">
                <input id="smtp_tls_skip_verify" type="checkbox" />
                <span class="slider"></span>
              </label>
            </div>
          </div>

          <div class="auth-actions" style="display:flex; gap:8px; align-items:center; justify-content:flex-start">
            <button id="saveSmtpBtn" class="btn primary" data-i18n-title="settings.saveSmtp" data-i18n-aria-label="settings.saveSmtp" title="保存" aria-label="保存"><i class="fa-solid fa-floppy-disk"></i></button>
            <button id="testSmtpBtn" class="btn" data-i18n-title="settings.testEmail" data-i18n-aria-label="settings.testEmail" title="测试" aria-label="测试"><i class="fa-solid fa-paper-plane"></i></button>
          </div>
          <div class="note" id="smtpMsg"></div>
        </div>

        <div class="section-divider"></div>

        <div style="margin-top:4px">
          <style>
            /* Scoped styles for users fullscreen */
            .users-panel{ position:relative; transition: border-radius .38s ease, box-shadow .38s ease, transform .38s ease, opacity .4s ease; }
            .users-panel.fullscreen{
              position:fixed; inset:0; z-index:50;
              background: var(--bg);
              border-radius:0; box-shadow:none;
              display:flex; flex-direction:column;
            }
            /* During fullscreen animation, keep transform transition enabled so zoom is visible */
            .users-panel.fs-anim{ transition: transform .5s ease, opacity .5s ease, border-radius .5s ease, box-shadow .5s ease; }
            .users-panel.fullscreen .users-header{ position:sticky; top:0; z-index:51; background:var(--panel); border-bottom:1px solid var(--border); }
            .users-topbar{ display:grid; grid-template-columns: 1fr auto; align-items:center; padding:6px 10px; }
            .users-title{ margin:8px 0; justify-self:start; }
            .users-panel.fullscreen .users-topbar{ grid-template-columns: 1fr auto 1fr; }
            .users-panel.fullscreen .users-title{ grid-column:2; justify-self:center; text-align:center; margin:6px 0; font-size:1.35rem; line-height:1.2; }
            .users-search{ padding:0 10px 8px; transition: opacity .35s ease; }
            /* In fullscreen, lay out: input | search | shrink at far right */
            .users-panel.fullscreen .users-search{ display:grid; grid-template-columns: 1fr auto auto; column-gap:8px; }
            .users-table-wrap{ margin-top:8px; overflow:auto; border:1px solid var(--border); border-radius:8px; transition: opacity .35s ease; }
            .users-panel.fullscreen .users-table-wrap{ margin:0; flex:1; border-left:none; border-right:none; border-radius:0; }
            .users-pager, .users-msg{ margin-top:8px; }
            .users-pager{ display:flex; justify-content:center; }
            /* 保持放大后分页条依然可见 */
            .users-panel.fullscreen .users-pager{ display:flex; justify-content:center; }
            .users-panel.fullscreen .users-msg{ display:block; }
            .users-fullscreen-btn i{ transition: transform .4s cubic-bezier(.2,.7,.2,1), opacity .3s ease; }
            .users-panel.fullscreen .users-fullscreen-btn i{ transform: rotate(180deg); }
            .users-count{ margin-left:0; color: var(--muted); font-weight:500; display:inline-flex; align-items:center; gap:6px; justify-self:end; }
            .users-panel.fullscreen .users-count{ grid-column:3; }
            .users-count i{ font-size:.95em; opacity:.9; }
            body.users-fullscreen{ overflow:hidden; }
          </style>

          <div id="usersPanel" class="users-panel">
            <div class="users-header">
              <div class="users-topbar">
                <h5 class="auth-title users-title" id="usersTitle" data-i18n="settings.userManagement">用户管理</h5>
                <span id="usersCount" class="note users-count"></span>
              </div>
              <div class="users-search row" style="gap:8px">
                <input id="searchInput" class="input" data-i18n-placeholder="settings.userSearchPlaceholder" placeholder="Search" />
                <button id="searchBtn" class="btn primary" data-i18n-title="settings.search" data-i18n-aria-label="settings.search" title="Search" aria-label="Search"><i class="fa-solid fa-magnifying-glass"></i></button>
                <button id="usersFullscreenBtn" class="btn icon users-fullscreen-btn" data-i18n-title="settings.fullscreen" data-i18n-aria-label="settings.fullscreen" title="Fullscreen" aria-label="Fullscreen"><i id="usersFsIcon" class="fa-solid fa-up-right-and-down-left-from-center"></i></button>
              </div>
            </div>
            <div class="users-table-wrap">
              <table style="width:100%; border-collapse:collapse">
              <thead>
                <tr>
                  <th style="text-align:left; padding:8px; border-bottom:1px solid var(--border)"><span class="th-sort" data-sort="id" data-i18n="settings.userId">ID</span></th>
                  <th style="text-align:left; padding:8px; border-bottom:1px solid var(--border)"><span class="th-sort" data-sort="email" data-i18n="settings.userEmail">邮箱</span></th>
                  <th style="text-align:left; padding:8px; border-bottom:1px solid var(--border)"><span class="th-sort" data-sort="created_at" data-i18n="settings.userCreatedAt">创建时间</span></th>
                  <th style="text-align:left; padding:8px; border-bottom:1px solid var(--border)"><span class="th-sort" data-sort="todo_count" data-i18n="settings.userTodoCount">待办数</span></th>
                  <th style="text-align:left; padding:8px; border-bottom:1px solid var(--border)" data-i18n="settings.actions">操作</th>
                </tr>
              </thead>
              <tbody id="usersTbody"></tbody>
              </table>
            </div>
            <div class="users-pager row" style="gap:8px;align-items:center">
              <button id="prevPage" class="btn" data-i18n-title="settings.prevPage" data-i18n-aria-label="settings.prevPage" title="Prev" aria-label="Prev"><i class="fa-solid fa-angle-left"></i></button>
              <span class="note" id="pageInfo">Page 1</span>
              <button id="nextPage" class="btn" data-i18n-title="settings.nextPage" data-i18n-aria-label="settings.nextPage" title="Next" aria-label="Next"><i class="fa-solid fa-angle-right"></i></button>
            </div>
            <div class="users-msg note" id="usersMsg" style="margin-top:6px"></div>
          </div>
        </div>
      </div>

      <!-- Admin modals -->
      <div id="adminModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
        <div class="modal">
          <h4 class="modal-title" id="adminModalTitle" data-i18n="settings.adminConfirmTitle">确认操作</h4>
          <div id="adminModalBody" class="note" style="margin-bottom:8px"></div>
          <input id="adminModalPwd" type="password" data-i18n-placeholder="settings.newPassword" placeholder="New Password" style="display:none; margin-bottom:8px" />
          <input id="adminModalInput" type="text" data-i18n-placeholder="settings.enterConfirm" placeholder="CONFIRM" />
          <div class="modal-actions">
            <button id="adminCancelBtn" class="btn" data-i18n="common.cancel">取消</button>
            <button id="adminOkBtn" class="btn danger" data-i18n="common.confirm">确认</button>
          </div>
          <div class="note" id="adminModalMsg"></div>
        </div>
      </div>
      <!-- SMTP test modal -->
      <div id="smtpTestModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
        <div class="modal">
          <h4 class="modal-title" data-i18n="settings.testEmail">测试发送邮件</h4>
          <p class="note" data-i18n="settings.testEmailHint">测试将使用当前表单中的 SMTP 配置。</p>
          <input id="smtpTestTo" type="email" data-i18n-placeholder="settings.testEmailPlaceholder" placeholder="Email" />
          <div class="modal-actions">
            <button id="smtpTestCancel" class="btn" data-i18n="common.cancel">取消</button>
            <button id="smtpTestSend" class="btn primary" data-i18n="settings.sendTestEmail">发送</button>
          </div>
          <div class="note" id="smtpTestMsg"></div>
        </div>
      </div>
      {% endif %}
    </div>

    {% if not is_admin %}
    <!-- Delete modal -->
    <div id="confirmModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
      <div class="modal">
        <h4 class="modal-title" data-i18n="settings.confirmDeleteTitle">确认删除账号</h4>
        <p class="note"><span data-i18n="settings.confirmDeleteMessage">请输入你的邮箱以确认：</span><strong>{{ email }}</strong></p>
        <input id="confirmEmail" type="email" data-i18n-placeholder="settings.confirmDeletePlaceholder" placeholder="输入邮箱确认" />
        <div class="modal-actions">
          <button id="cancelDelete" class="btn" data-i18n="common.cancel">取消</button>
          <button id="confirmDelete" class="btn danger" data-i18n="settings.confirmDeleteButton">确认删除</button>
        </div>
        <div class="note" id="delMsg"></div>
      </div>
    </div>
    {% endif %}

    <script>
      const csrf = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
      function escapeHtml(s){
        return (s||'').replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));
      }
      const email = document.getElementById('email').textContent.trim();
      const modal = document.getElementById('confirmModal');
      const pwdMsg = document.getElementById('pwdMsg');
      const delMsg = document.getElementById('delMsg');
      function tr(key){
        return (window.i18n && typeof window.i18n.t === 'function') ? window.i18n.t(key) : key;
      }
      function trf(key, vars){
        let s = tr(key);
        if(vars){
          Object.entries(vars).forEach(([k,v])=>{ s = s.replace(new RegExp('\\{'+k+'\\}','g'), v); });
        }
        return s;
      }

      document.getElementById('backBtn').onclick = ()=>{ location.href='/' };
      document.getElementById('logoutBtn').onclick = async ()=>{
        try{ await fetch('/api/auth/logout', { method:'POST', credentials:'include' }); }catch{}
        // Clear all local storage on logout
        try{ localStorage.clear(); }catch{}
        // Ask SW to purge caches but keep offline page available
        if(navigator.serviceWorker && navigator.serviceWorker.controller){
          try{ navigator.serviceWorker.controller.postMessage({ type:'LOGOUT_CLEAR_CACHES_KEEP_OFFLINE' }); }catch{}
          // Also clear page cache for older SW versions
          try{ navigator.serviceWorker.controller.postMessage({ type:'CLEAR_PAGE_CACHE' }); }catch{}
        }
        location.href='/login';
      };

      document.getElementById('changePwdBtn').onclick = async ()=>{
        pwdMsg.textContent = '';
        const current = document.getElementById('current').value;
        const nu = document.getElementById('new').value;
        const cf = document.getElementById('confirm').value;
        if(nu !== cf){ pwdMsg.textContent = tr('settings.passwordMismatch'); return }
        try{
          const r = await fetch('/api/auth/change_password', {
            method:'POST', credentials:'include',
            headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrf },
            body: JSON.stringify({ current, new: nu })
          });
          if(!r.ok){ const j = await r.json().catch(()=>({})); throw new Error(j.error||('HTTP '+r.status)) }
          pwdMsg.textContent = tr('settings.passwordUpdated');
          document.getElementById('current').value = '';
          document.getElementById('new').value = '';
          document.getElementById('confirm').value = '';
        }catch(e){ pwdMsg.textContent = tr('settings.updateFailed')+e.message }
      };

      {% if not is_admin %}
      document.getElementById('deleteAccountOpen').onclick = ()=>{
        modal.style.display = 'flex';
        modal.setAttribute('aria-hidden','false');
        document.getElementById('confirmEmail').focus();
      };
      document.getElementById('cancelDelete').onclick = ()=>{
        modal.style.display = 'none';
        modal.setAttribute('aria-hidden','true');
        delMsg.textContent = '';
        document.getElementById('confirmEmail').value = '';
      };
      document.getElementById('confirmDelete').onclick = async ()=>{
        delMsg.textContent = '';
        const typed = document.getElementById('confirmEmail').value.trim();
        if(typed !== email){ delMsg.textContent = tr('settings.emailMismatch'); return }
        try{
          await fetch('/api/auth/delete_account', { method:'DELETE', credentials:'include', headers: { 'X-CSRF-Token': csrf } });
          localStorage.removeItem('todos');
          location.href = '/login';
        }catch(e){ delMsg.textContent = tr('settings.deleteFailed'); }
      };
      {% endif %}

      {% if is_admin %}
      // Admin logic
      const regSwitch = document.getElementById('registration_open');
      const regHelp = document.getElementById('regHelp');
      const smtpMsg = document.getElementById('smtpMsg');
      const smtpEnabledToggle = document.getElementById('smtp_enabled');
      let smtpPasswordSet = false; // server-state: whether password already set
      let tsSecretSet = false; // server-state: whether Turnstile secret already set
      const amodal = document.getElementById('adminModal');
      const amsg = document.getElementById('adminModalMsg');
      const atitle = document.getElementById('adminModalTitle');
      const abody = document.getElementById('adminModalBody');
      const ainput = document.getElementById('adminModalInput');
      const apwd = document.getElementById('adminModalPwd');
      const aok = document.getElementById('adminOkBtn');
      const acancel = document.getElementById('adminCancelBtn');

      function setOpen(open){
        regSwitch.checked = !!open;
        regHelp.textContent = open ? tr('settings.allowNewUsers') : tr('settings.disallowNewUsers');
      }
      function smtpConfigValid(){
        const host = document.getElementById('smtp_host').value.trim();
        const port = document.getElementById('smtp_port').value.trim();
        const username = document.getElementById('smtp_username').value.trim();
        const sender = document.getElementById('smtp_sender').value.trim();
        const pwVal = document.getElementById('smtp_password').value;
        const passwordEffective = pwVal && pwVal.trim().length > 0 ? true : smtpPasswordSet;
        const portNum = parseInt(port, 10);
        return !!(host && username && sender && Number.isFinite(portNum) && portNum > 0 && passwordEffective);
      }
      function updateSmtpToggleState(){
        // Keep toggle interactive; validation occurs on toggle/save and may revert state
        const valid = smtpConfigValid();
        if(!valid && smtpEnabledToggle.checked){
          smtpEnabledToggle.checked = false;
        }
      }
      async function loadConfig(){
        const r = await fetch('/api/admin/config', { credentials:'include' });
        const j = await r.json();
        const c = j.config || {};
        setOpen(!!c.registration_open);
        document.getElementById('smtp_use_tls').checked = !!c.smtp_use_tls;
        document.getElementById('smtp_enabled').checked = !!c.smtp_enabled;
        document.getElementById('smtp_host').value = c.smtp_host || '';
        document.getElementById('smtp_port').value = c.smtp_port || '';
        document.getElementById('smtp_username').value = c.smtp_username || '';
        smtpPasswordSet = !!c.smtp_password_set;
        document.getElementById('smtp_password').placeholder = smtpPasswordSet ? tr('settings.smtpPasswordSet') : tr('settings.smtpPassword');
        document.getElementById('smtp_sender').value = c.smtp_sender || '';
        const skipEl = document.getElementById('smtp_tls_skip_verify');
        if(skipEl) skipEl.checked = !!c.smtp_tls_skip_verify;
        updateSmtpToggleState();
        // Turnstile
        const tsEnabled = document.getElementById('turnstile_enabled');
        const tsSite = document.getElementById('turnstile_site_key');
        const tsSecret = document.getElementById('turnstile_secret_key');
        const tsSkip = document.getElementById('turnstile_tls_skip_verify');
        if(tsEnabled) tsEnabled.checked = !!c.turnstile_enabled;
        if(tsSite) tsSite.value = c.turnstile_site_key || '';
        tsSecretSet = !!c.turnstile_secret_set;
        if(tsSecret) tsSecret.placeholder = (tsSecretSet ? tr('settings.turnstileSecretSet') : tr('settings.secretKey'));
        if(tsSkip) tsSkip.checked = !!c.turnstile_tls_skip_verify;
      }
      regSwitch.addEventListener('change', async ()=>{
        const open = regSwitch.checked;
        await fetch('/api/admin/config', { method:'POST', credentials:'include', headers:{'Content-Type':'application/json','X-CSRF-Token': csrf}, body: JSON.stringify({ registration_open: open }) });
        setOpen(open);
      });
      // Live validate SMTP fields to enable/disable toggle
      ['smtp_host','smtp_port','smtp_username','smtp_password','smtp_sender'].forEach(id=>{
        document.getElementById(id).addEventListener('input', updateSmtpToggleState);
      });
      // Toggle SMTP enabled immediately with validation and automatic revert on failure
      smtpEnabledToggle.addEventListener('change', async ()=>{
        smtpMsg.textContent = '';
        const enabled = smtpEnabledToggle.checked;
        const body = {
          smtp_enabled: enabled,
          smtp_host: document.getElementById('smtp_host').value.trim(),
          smtp_port: document.getElementById('smtp_port').value.trim(),
          smtp_username: document.getElementById('smtp_username').value.trim(),
          smtp_password: document.getElementById('smtp_password').value,
          smtp_use_tls: document.getElementById('smtp_use_tls').checked,
          smtp_sender: document.getElementById('smtp_sender').value.trim(),
          smtp_tls_skip_verify: document.getElementById('smtp_tls_skip_verify') ? document.getElementById('smtp_tls_skip_verify').checked : false,
        };
        // Front-end guard: cannot enable without valid config
        if(enabled && !smtpConfigValid()){
          smtpMsg.textContent = tr('settings.smtpFillRequiredBeforeEnable');
          smtpEnabledToggle.checked = false;
          return;
        }
        // Do not overwrite saved password if input empty
        if(!body.smtp_password) delete body.smtp_password;
        try{
          const r = await fetch('/api/admin/config', { method:'POST', credentials:'include', headers:{'Content-Type':'application/json','X-CSRF-Token': csrf}, body: JSON.stringify(body) });
          const j = await r.json().catch(()=>({}));
          if(!r.ok){
            const map = { smtp_invalid: tr('settings.smtpInvalidConfig') };
            smtpMsg.textContent = (map[j.error] || (j.error || ('HTTP '+r.status)));
            smtpEnabledToggle.checked = false; // revert on failure
            return;
          }
          // success
          if(enabled){
            smtpMsg.textContent = tr('settings.smtpEnabled');
            if(body.smtp_password && body.smtp_password.length>0){ smtpPasswordSet = true; }
          }else{
            smtpMsg.textContent = tr('settings.smtpDisabled');
          }
          document.getElementById('smtp_password').value = '';
        }catch(e){
          smtpMsg.textContent = tr('settings.saveFailedPrefix') + (e && e.message ? e.message : tr('settings.unknownError'));
          smtpEnabledToggle.checked = false; // revert on error
        }
      });
      document.getElementById('saveSmtpBtn').onclick = async ()=>{
        smtpMsg.textContent = '';
        const body = {
          smtp_host: document.getElementById('smtp_host').value.trim(),
          smtp_port: document.getElementById('smtp_port').value.trim(),
          smtp_username: document.getElementById('smtp_username').value.trim(),
          smtp_password: document.getElementById('smtp_password').value,
          smtp_use_tls: document.getElementById('smtp_use_tls').checked,
          smtp_sender: document.getElementById('smtp_sender').value.trim(),
          smtp_tls_skip_verify: document.getElementById('smtp_tls_skip_verify') ? document.getElementById('smtp_tls_skip_verify').checked : false,
          smtp_enabled: document.getElementById('smtp_enabled').checked,
        };
        // If password input is empty, don't send field to avoid overwrite
        if(!body.smtp_password) delete body.smtp_password;
        // Guard: cannot enable if config invalid
        if(body.smtp_enabled && !smtpConfigValid()){
          smtpMsg.textContent = tr('settings.smtpFillRequiredBeforeEnable');
          return;
        }
        try{
          const r = await fetch('/api/admin/config', { method:'POST', credentials:'include', headers:{'Content-Type':'application/json','X-CSRF-Token': csrf}, body: JSON.stringify(body) });
          if(!r.ok){
            const j = await r.json().catch(()=>({}));
            // Revert toggle if enabling failed
            if(body.smtp_enabled){ document.getElementById('smtp_enabled').checked = false; }
            throw new Error(j.error||('HTTP '+r.status));
          }
          smtpMsg.textContent = tr('settings.saved');
          // If password was provided and saved, mark as set for future validation
          if(body.smtp_password && body.smtp_password.length>0){
            smtpPasswordSet = true;
          }
          updateSmtpToggleState();
        }catch(e){ smtpMsg.textContent = tr('settings.saveFailedPrefix')+e.message }
      };

      // Save Turnstile config
      const tsMsg = document.getElementById('tsMsg');
      const saveTsBtn = document.getElementById('saveTsBtn');
      if(saveTsBtn){
        saveTsBtn.addEventListener('click', async ()=>{
          if(tsMsg) tsMsg.textContent = '';
          const enabled = document.getElementById('turnstile_enabled').checked;
          const site = document.getElementById('turnstile_site_key').value.trim();
          const secret = document.getElementById('turnstile_secret_key').value;
          // Guard: when enabling, require site and either new secret or an already-set secret
            if(enabled && (!site || (!secret && !tsSecretSet))){
            if(tsMsg) tsMsg.textContent = tr('settings.turnstileFillKeys');
            return;
          }
          const payload = { turnstile_enabled: enabled, turnstile_site_key: site, turnstile_tls_skip_verify: (document.getElementById('turnstile_tls_skip_verify') ? document.getElementById('turnstile_tls_skip_verify').checked : false) };
          if(secret) payload.turnstile_secret_key = secret; // omit if empty to keep existing
          try{
            const r = await fetch('/api/admin/config', { method:'POST', credentials:'include', headers:{'Content-Type':'application/json','X-CSRF-Token': csrf}, body: JSON.stringify(payload) });
            const j = await r.json().catch(()=>({}));
            if(!r.ok){
              const map = { turnstile_invalid: tr('settings.turnstileInvalid') };
              // Revert toggle if enabling failed
              if(enabled){ document.getElementById('turnstile_enabled').checked = false; }
              throw new Error(map[j.error] || (j.error || ('HTTP '+r.status)));
            }
            if(tsMsg) tsMsg.textContent = tr('settings.saved');
            await loadConfig();
          }catch(e){ if(tsMsg) tsMsg.textContent = tr('settings.saveFailedPrefix') + (e && e.message ? e.message : tr('settings.unknownError')); }
        });
      }
      // Toggle Turnstile enabled with validation and automatic revert
      const tsEnabledToggle = document.getElementById('turnstile_enabled');
      if(tsEnabledToggle){
        tsEnabledToggle.addEventListener('change', async ()=>{
          if(tsMsg) tsMsg.textContent = '';
          const enabled = tsEnabledToggle.checked;
          const site = document.getElementById('turnstile_site_key').value.trim();
          const secret = document.getElementById('turnstile_secret_key').value;
          // Guard: when enabling, require site and either new secret or an already-set secret
          if(enabled && (!site || (!secret && !tsSecretSet))){
            if(tsMsg) tsMsg.textContent = tr('settings.turnstileFillKeys');
            tsEnabledToggle.checked = false;
            return;
          }
          const payload = { turnstile_enabled: enabled, turnstile_site_key: site, turnstile_tls_skip_verify: (document.getElementById('turnstile_tls_skip_verify') ? document.getElementById('turnstile_tls_skip_verify').checked : false) };
          if(secret) payload.turnstile_secret_key = secret; // omit if empty to keep existing
          try{
            const r = await fetch('/api/admin/config', { method:'POST', credentials:'include', headers:{'Content-Type':'application/json','X-CSRF-Token': csrf}, body: JSON.stringify(payload) });
            const j = await r.json().catch(()=>({}));
            if(!r.ok){
              const map = { turnstile_invalid: tr('settings.turnstileInvalid') };
              if(tsMsg) tsMsg.textContent = map[j.error] || (j.error || ('HTTP '+r.status));
              tsEnabledToggle.checked = false; // revert
              return;
            }
            if(enabled){ if(tsMsg) tsMsg.textContent = tr('settings.turnstileEnabled'); } else { if(tsMsg) tsMsg.textContent = tr('settings.turnstileDisabled'); }
            await loadConfig();
          }catch(e){
            if(tsMsg) tsMsg.textContent = tr('settings.saveFailedPrefix') + (e && e.message ? e.message : tr('settings.unknownError'));
            tsEnabledToggle.checked = false;
          }
        });
      }

      // Users table
      let page = 1, sort = 'id', order = 'asc', q = '';
      const tbody = document.getElementById('usersTbody');
      const pageInfo = document.getElementById('pageInfo');
      const usersMsg = document.getElementById('usersMsg');
      const usersCountEl = document.getElementById('usersCount');
      const prevBtn = document.getElementById('prevPage');
      const nextBtn = document.getElementById('nextPage');
      const currentUserEmail = document.getElementById('email').textContent.trim();
      function rowHtml(u){
        const isSelf = (u.email === currentUserEmail);
        const pwdTitle = isSelf ? tr('settings.cannotResetSelf') : tr('settings.resetUserPassword');
        const delTitle = isSelf ? tr('settings.cannotDeleteSelf') : tr('settings.deleteUser');
        return `
          <tr>
            <td style="padding:8px;border-bottom:1px solid var(--border)">${u.id}</td>
            <td style="padding:8px;border-bottom:1px solid var(--border)">${escapeHtml(u.email)}</td>
            <td style="padding:8px;border-bottom:1px solid var(--border)">${u.created_at}</td>
            <td style="padding:8px;border-bottom:1px solid var(--border)">${u.todo_count}</td>
            <td style="padding:8px;border-bottom:1px solid var(--border); white-space:nowrap">
              <div class="row" style="gap:6px; flex-wrap:nowrap">
                <button class="btn" data-act="pwd" data-id="${u.id}" data-email="${escapeHtml(u.email)}" ${isSelf?'disabled aria-disabled="true"':''} title="${pwdTitle}" aria-label="${pwdTitle}"><i class="fa-solid fa-key" style="${isSelf?'color:var(--border);opacity:.6;':''}"></i></button>
                <button class="btn danger" data-act="del" data-id="${u.id}" data-email="${escapeHtml(u.email)}" ${isSelf?'disabled aria-disabled="true"':''} title="${delTitle}" aria-label="${delTitle}"><i class="fa-solid fa-user-xmark" style="${isSelf?'color:var(--border);opacity:.6;':''}"></i></button>
              </div>
            </td>
          </tr>`;
      }
      async function loadUsers(){
        const r = await fetch(`/api/admin/users?page=${page}&sort=${encodeURIComponent(sort)}&order=${encodeURIComponent(order)}&q=${encodeURIComponent(q)}`, { credentials:'include' });
        const j = await r.json();
        const list = j.users || [];
        tbody.innerHTML = list.map(rowHtml).join('');
        const total = j.total || 0;
        const pages = Math.max(1, Math.ceil(total/10));
        // 若当前页超过可用总页数，则回退到最后一页并重载
        if(page > pages){ page = pages; return loadUsers(); }
        pageInfo.textContent = trf('settings.pageInfo', { page, pages, total });
        if(usersCountEl){ usersCountEl.innerHTML = `<i class="fa-solid fa-users"></i> ${trf('settings.usersTotal', { total })}`; }
        usersMsg.textContent = '';
        // 更新翻页按钮可用状态
        if(prevBtn){
          const disabled = page <= 1;
          prevBtn.disabled = disabled;
          prevBtn.setAttribute('aria-disabled', disabled ? 'true' : 'false');
        }
        if(nextBtn){
          const disabled = page >= pages;
          nextBtn.disabled = disabled;
          nextBtn.setAttribute('aria-disabled', disabled ? 'true' : 'false');
        }
      }
      if(prevBtn){ prevBtn.onclick = ()=>{ if(page>1){ page--; loadUsers(); } }; }
      if(nextBtn){ nextBtn.onclick = ()=>{ if(!nextBtn.disabled){ page++; loadUsers(); } }; }
      document.getElementById('searchBtn').onclick = ()=>{ q = document.getElementById('searchInput').value.trim(); page=1; loadUsers(); };
      // 即时模糊搜索（防抖）
      {
        let t;
        const si = document.getElementById('searchInput');
        si.addEventListener('input', ()=>{
          clearTimeout(t);
          t = setTimeout(()=>{ q = si.value.trim(); page = 1; loadUsers(); }, 250);
        });
        si.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); q = si.value.trim(); page=1; loadUsers(); } });
      }
      document.querySelectorAll('th [data-sort]').forEach(btn=>{
        btn.onclick = ()=>{
          const s = btn.getAttribute('data-sort');
          if(sort === s){ order = (order==='asc')?'desc':'asc'; }
          else{ sort = s; order = 'asc'; }
          page = 1; loadUsers();
        };
      });

      tbody.addEventListener('click', (e)=>{
        const btn = e.target.closest('button');
        if(!btn) return;
        if(btn.disabled) return; // 自身行已禁用操作
        const id = parseInt(btn.getAttribute('data-id'), 10);
        const email = btn.getAttribute('data-email');
        const act = btn.getAttribute('data-act');
        amsg.textContent = '';
        ainput.value = '';
        if(apwd){ apwd.value = ''; apwd.style.display = 'none'; }
        amodal.style.display = 'flex';
        amodal.setAttribute('aria-hidden','false');
        if(act==='del'){
          atitle.textContent = tr('settings.deleteUserTitle');
          abody.textContent = trf('settings.deleteUserBody', { email });
          if(apwd){ apwd.style.display = 'none'; }
          ainput.placeholder = tr('settings.enterConfirm');
          setTimeout(()=> ainput && ainput.focus(), 0);
          aok.onclick = async ()=>{
            if(ainput.value.trim() !== 'CONFIRM'){ amsg.textContent=tr('settings.enterConfirm'); return }
            try{
              const r = await fetch(`/api/admin/users/${id}`, { method:'DELETE', credentials:'include', headers: { 'X-CSRF-Token': csrf } });
              if(!r.ok){ const j = await r.json().catch(()=>({})); throw new Error(j.error||('HTTP '+r.status)); }
              amodal.style.display = 'none';
              loadUsers();
            }catch(e){ amsg.textContent = tr('settings.operationFailedPrefix')+e.message }
          };
        }else if(act==='pwd'){
          atitle.textContent = tr('settings.resetUserTitle');
          abody.textContent = trf('settings.resetUserBody', { email });
          if(apwd){ apwd.style.display = 'block'; }
          ainput.placeholder = tr('settings.enterConfirm');
          setTimeout(()=> apwd && apwd.focus(), 0);
          aok.onclick = async ()=>{
            const newp = apwd ? apwd.value : '';
            const key = ainput.value.trim();
            if(key !== 'CONFIRM'){ amsg.textContent=tr('settings.enterConfirmToProceed'); return }
            if(!newp || newp.length < 8){ amsg.textContent=tr('settings.passwordAtLeast8'); return }
            try{
              const r = await fetch(`/api/admin/users/${id}/password`, { method:'POST', credentials:'include', headers: { 'Content-Type':'application/json', 'X-CSRF-Token': csrf }, body: JSON.stringify({ new: newp }) });
              if(!r.ok){ const j = await r.json().catch(()=>({})); throw new Error(j.error||('HTTP '+r.status)); }
              amodal.style.display = 'none';
              usersMsg.textContent = tr('settings.passwordUpdated');
            }catch(e){ amsg.textContent = tr('settings.operationFailedPrefix')+e.message }
          };
        }
      });
      acancel.onclick = ()=>{ amodal.style.display='none'; amsg.textContent=''; ainput.value=''; if(apwd){ apwd.value=''; apwd.style.display='none'; } };

      // SMTP test modal logic
      const testBtn = document.getElementById('testSmtpBtn');
      const testModal = document.getElementById('smtpTestModal');
      const testTo = document.getElementById('smtpTestTo');
      const testMsg = document.getElementById('smtpTestMsg');
      const testSend = document.getElementById('smtpTestSend');
      const testCancel = document.getElementById('smtpTestCancel');

      function openTestModal(){
        if(testMsg) testMsg.textContent = '';
        if(testTo) testTo.value = '';
        if(testModal){
          testModal.style.display = 'flex';
          testModal.setAttribute('aria-hidden','false');
          setTimeout(()=>testTo && testTo.focus(), 0);
        }
      }
      function closeTestModal(){
        if(testModal){
          testModal.style.display = 'none';
          testModal.setAttribute('aria-hidden','true');
        }
        if(testMsg) testMsg.textContent = '';
        if(testTo) testTo.value = '';
      }
      if(testBtn){ testBtn.addEventListener('click', openTestModal); }
      if(testCancel){ testCancel.addEventListener('click', closeTestModal); }
      if(testSend){
        testSend.addEventListener('click', async ()=>{
          testMsg.textContent = '';
          const to = (testTo.value||'').trim();
          if(!to || !to.includes('@')){ testMsg.textContent=tr('settings.enterValidRecipient'); return }
          testSend.disabled = true;
          try{
            const payload = {
              to,
              smtp_host: document.getElementById('smtp_host').value.trim(),
              smtp_port: document.getElementById('smtp_port').value.trim(),
              smtp_username: document.getElementById('smtp_username').value.trim(),
              smtp_password: document.getElementById('smtp_password').value,
              smtp_use_tls: document.getElementById('smtp_use_tls').checked,
              smtp_sender: document.getElementById('smtp_sender').value.trim(),
              smtp_tls_skip_verify: document.getElementById('smtp_tls_skip_verify') ? document.getElementById('smtp_tls_skip_verify').checked : false,
            };
            if(!payload.smtp_password) delete payload.smtp_password; // use saved password if empty
            const r = await fetch('/api/admin/smtp_test', { method:'POST', credentials:'include', headers: { 'Content-Type':'application/json', 'X-CSRF-Token': csrf }, body: JSON.stringify(payload) });
            const j = await r.json().catch(()=>({}));
            if(!r.ok){
              const map = {
                smtp_invalid: tr('settings.smtpInvalidRequired'),
                smtp_auth_failed: tr('settings.smtpAuthFailed'),
                smtp_send_failed: tr('settings.smtpSendFailed')
              };
              const base = map[j.error] || (tr('settings.sendFailedPrefix') + (j.error || ('HTTP '+r.status)));
              const extra = j.detail ? `（${j.detail}）` : '';
              testMsg.textContent = base + extra;
              return;
            }
            testMsg.textContent = tr('settings.testMailSent');
          }catch(e){
            // Network or unexpected errors
            testMsg.textContent = tr('settings.sendFailedPrefix') + (e && e.message ? e.message : tr('settings.unknownError'));
          }finally{
            testSend.disabled = false;
          }
        });
      }

      // init
      loadConfig().then(loadUsers).catch(()=>{});
      // Users fullscreen toggle
      const usersPanel = document.getElementById('usersPanel');
      const usersFsBtn = document.getElementById('usersFullscreenBtn');
      const usersFsIcon = document.getElementById('usersFsIcon');
      if(usersFsBtn && usersPanel){
        usersFsBtn.addEventListener('click', ()=>{
          // add anim class; subtle scale for clearer zoom perception
          usersPanel.classList.add('fs-anim');
          usersPanel.style.transform = 'scale(0.4)';
          usersPanel.style.opacity = '0';
          setTimeout(()=>{
            const on = usersPanel.classList.toggle('fullscreen');
            document.body.classList.toggle('users-fullscreen', on);
            usersFsBtn.title = on ? tr('settings.exitFullscreen') : tr('settings.fullscreen');
            usersFsBtn.setAttribute('aria-label', usersFsBtn.title);
            // icon fade + rotate
            if(usersFsIcon){
              usersFsIcon.style.opacity = '0';
              setTimeout(()=>{
                usersFsIcon.className = 'fa-solid ' + (on ? 'fa-down-left-and-up-right-to-center' : 'fa-up-right-and-down-left-from-center');
                usersFsIcon.style.opacity = '1';
              }, 160);
            }
            // fade + scale back in
            requestAnimationFrame(()=>{
              usersPanel.style.opacity = '1';
              usersPanel.style.transform = 'scale(1)';
              setTimeout(()=>{
                usersPanel.classList.remove('fs-anim');
                usersPanel.style.opacity='';
                usersPanel.style.transform='';
              }, 420);
            });
          }, 40);
        });
      }
      {% endif %}
  </script>
    <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
    <script src="/static/js/locales/zh-CN.js"></script>
    <script src="/static/js/locales/en.js"></script>
    <script src="/static/js/locales/ja.js"></script>
    <script src="/static/js/i18n.js"></script>
    <script src="/static/js/theme.js"></script>
    <script src="/static/js/pwa.js"></script>
    <script>
      // Initialize language button after i18n is loaded
      (function initLanguage() {
        function init() {
          if (window.i18n && window.i18n.initLanguageButton) {
            window.i18n.initLanguageButton();
          } else {
            // Retry if i18n not ready yet
            setTimeout(init, 50);
          }
        }
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', init);
        } else {
          init();
        }
      })();
    </script>
    <footer class="site-footer">
      Powered by <a href="https://github.com/umink-lab/easytodo" target="_blank" rel="noopener noreferrer">EasyTodo</a> · Copyright <a href="https://github.com/essesoul" target="_blank" rel="noopener noreferrer">Essesoul</a>
    </footer>
  </body>
  </html>
